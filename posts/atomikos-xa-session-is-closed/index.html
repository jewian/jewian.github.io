<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>AtomikosSQLException: The underlying XA session is closed - 业言 Randy Huang</title>
    <meta name="author" content="Randy Huang">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed.xml" rel="alternate" title="Ewal.net" type="application/atom+xml">
    <link href="/favicon.png" rel="shortcut icon">

    <!-- Google Font -->
    <link href='http://fonts.googleapis.com/css?family=Tangerine' rel='stylesheet' type='text/css'>
    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.54.2" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><span class="text-primary sign">业言 Randy Huang</span></a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/archives/">Archives</a></li>
                <li class="hidden-xs">
                    <a href="/feed.xml" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://github.com/jewian" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:wenye.info">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-sm-12 col-md-10">
            <article id="post" class="post">
    <div class="post-date">Feb 2nd, 2014</div>
    
    <h1>AtomikosSQLException: The underlying XA session is closed</h1>
    
    <div class="post-content">
        <p>My current project is using <a href="http://mybatis.github.io/mybatis-3/">Mybatis</a> for data persistence, and using <a href="http://www.atomikos.com/">Atomikos TransactionEssentials</a> as <a href="http://en.wikipedia.org/wiki/Two-phase_commit_protocol">2PC</a> transaction manager.</p>
<p>In the testing site when there were a few peoples testing, following exception happened from time to time. But you could not always reproduce it.</p>
<blockquote>
<p>Caused by: com.atomikos.jdbc.AtomikosSQLException: The underlying XA session is closed
  at com.atomikos.jdbc.AtomikosSQLException.throwAtomikosSQLException(AtomikosSQLException.java:44)
   at com.atomikos.jdbc.AtomikosConnectionProxy.enlist(AtomikosConnectionProxy.java:214)
   at com.atomikos.jdbc.AtomikosConnectionProxy.invoke(AtomikosConnectionProxy.java:138)
   at $Proxy31.prepareStatement(Unknown Source)</p>
</blockquote>
<p>After investigation for a whole day, finally I found the place causing this error.</p>
<pre><code class="lang-java">    public static List&lt;DynamicEntity&gt; findByQuery(final String queryId,
            final Map&lt;String, Object&gt; params) throws DataException {
        Connection conn = null;
        SqlSession session = null;
        try {
            conn = DaoFactory.getInstance().getConnection();
            session = DaoFactory.getSession(conn);
            return session.selectList(queryId, params);
        } finally {
            if (session != null) {
                session.close();
            }
            if (conn != null) {
                conn.close();
            }
        }
    }</code></pre>
<p><strong>RootCause</strong></p>
<p>The line <code>session.close()</code> will close the DB connection implicitly (return to connection pool). If at the same time, another thread (ThreadB) is requesting a new DB connection, connection pool may return the same connection by Atomikos.</p>
<p>The line <code>conn.close()</code> closes the connection again. (Ooops, your are right, it is closing the connection already using by ThreadB). Then if ThreadB tries to retrieve data by the connection, <code>The underlying XA session is closed</code> exception happens.</p>
<p>After I tried to removed one line of them, the exception was gone.</p>

    </div>
    
    <div class="post-tags">
        Posted In: <a href='/tags/atomikos/'>Atomikos</a>, <a href='/tags/mybatis/'>Mybatis</a>, <a href='/tags/xa/'>XA</a>
    </div>
    
</article>
            <div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<script type="text/javascript">
    var disqus_shortname = 'wenye';
    var disqus_url = 'http://wenye.info/posts/atomikos-xa-session-is-closed/';
    var disqus_identifier = disqus_url;
    var disqus_title = 'AtomikosSQLException: The underlying XA session is closed';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

            <div id="me">
</div>

        </div>
    </div>
</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Copyright &copy; 2014 <span class="sign">业言 Randy Huang</span></p>
    </div>
</div>



<script src="/scripts/vendor/jquery-1.10.2.min.js"></script>
<script src="/scripts/vendor/bootstrap.min.js"></script>
<script src="/scripts/vendor/jquery.fancybox.pack.js"></script>
<script src="/scripts/vendor/highlight.pack.js"></script>
<script src="/scripts/vendor/coffee-script.js"></script>
<script src="/scripts/site.js"></script>
</body>
</html>